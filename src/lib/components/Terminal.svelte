<script lang="ts">
  import { onDestroy, onMount } from 'svelte';
  import 'xterm/css/xterm.css';
  import { Terminal } from '@xterm/xterm';
  import { FitAddon } from '@xterm/addon-fit';
  import { CanvasAddon } from '@xterm/addon-canvas';

  let typedPrompt = '';
  let prompt =
    '\x1b[1;32m' +
    'pentest' +
    '\x1b[0m' +
    '\x1b[1;31m' +
    '@\x1b[0m' +
    '\x1b[34m' +
    'bi0s' +
    '\x1b[0m' +
    '\x1b[1;31m' +
    '~$' +
    '\x1b[0m' +
    ' ';
  let termElem: HTMLElement;
  let term: Terminal;
  let fitTermAddon: FitAddon;
  let resizeObserver: ResizeObserver;

  onMount(() => {
    // TODO: toggle light mode and dark mode
    term = new Terminal({
      allowTransparency: true,
      scrollOnUserInput: true,
      // convertEol: true,
      fontFamily: 'Roboto Mono',
      fontSize: 15,
      theme: {
        black: '#383a42',
        brightBlack: '#383a42',
        blue: '#61afef',
        brightBlue: '#61afef',
        brightCyan: '#56b6c2',
        cyan: '#56b6c2',
        brightGreen: '#98c379',
        green: '#98c379',
        brightMagenta: '#c678dd',
        magenta: '#c678dd',
        brightRed: '#e06c75',
        red: '#e06c75',
        brightWhite: '#fafafa',
        white: '#fafafa',
        brightYellow: '#e5c07b',
        yellow: '#e5c07b',
        background: '#282c34',
        foreground: '#abb2bf',
        cursor: '#abb2bf',
        selectionBackground: '#abb2bf',
        selectionForeground: '#282c34',
        cursorAccent: '',
        extendedAnsi: [],
        selectionInactiveBackground: '#abb2bf'
      }
    });
    fitTermAddon = new FitAddon();
    term.loadAddon(new CanvasAddon());
    term.loadAddon(fitTermAddon);

    const font = new FontFace('Roboto Mono', 'url("/fonts/roboto.woff2")');
    document.fonts.add(font);
    font.load().then(() => {
      term.open(termElem);
      term.writeln(
        '\x1b[1;35m' +
          'Type `help` to get a list of commands you can run on this terminal.' +
          '\x1b[0m'
      );
      term.write(prompt);
      fitTermAddon.fit();
      // TODO: Integrate all commands into an object so that help can get updated automatically
      term.onData((e) => {
        if (e == '\r') {
          term.writeln('');
          switch (typedPrompt) {
            case 'help':
              term.writeln(
                [
                  'help: prints out all commands you can try out',
                  'ls: Lists out files and directories of the present working directory',
                  'pwd: Prints out the present working directory',
                  'cd: Used to change or navigate through directories',
                  'less: Used to read through files.',
                  'find: Used to find files.'
                ].join('\r\n')
              );
              break;
            default:
              term.writeln(typedPrompt + ': command not found');
              break;
          }
          typedPrompt = '';
          term.write(prompt);
        } else if (e == '\u007F') {
          if (typedPrompt.length > 0) {
            typedPrompt = typedPrompt.slice(0, -1);
            term.write('\b \b');
          }
        } else {
          typedPrompt += e;
          term.write(e);
        }
      });

      resizeObserver = new ResizeObserver(() => {
        fitTermAddon.fit();
      });
      resizeObserver.observe(termElem);
    });
  });

  onDestroy(async () => {
    resizeObserver.unobserve(termElem);
    resizeObserver.disconnect();
  });
</script>

<div class="terminal" bind:this={termElem}></div>

<style>
  .terminal {
    position: fixed;
    top: 55px;
    bottom: 55px;
    left: 15px;
    right: 15px;
  }
</style>
